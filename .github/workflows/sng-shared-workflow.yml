on:
  workflow_call:
    secrets:
      secret-auth:
        description: "SECRET_AUTH value from secrets"
        required: true
      gcloud-auth-staging:
        description: "GCLOUD_AUTH_STAGING value from secrets"
        required: true
      gcloud-auth-prod:
        description: "GCLOUD_AUTH_PROD value from secrets"
        required: true
      sql-password:
        description: "MSSQL 'sa' password (needed when running tests). Must be set when 'start-sql' input parameter is 'true'"
        required: false
    inputs:
      gcr-image-name:
        description: |
          Google Container Registry Docker image name
        type: string
        required: true
      service-name:
        description: |
          Service name in GCP
        type: string
        required: true
      sln-path:
        description: |
          Path to solution file
        type: string
        required: true
      dockerfile-path:
        description: |
          Path to Dockerfile
        type: string
        required: true
      system-name:
        description: |
          System name (sng or mcp)
        type: string
        required: false
        default: "sng"
      use-scanngo-acceptance:
        description: |
          Use acceptance action
        type: boolean
        required: false
      acceptance-username:
        description: |
          Acceptance username. Must be set when 'use-scanngo-acceptance' is 'true'
        type: string
        required: false
      acceptance-postman-collection-path:
        description: 'Path to Postman collection'
        required: false
        type: string
        default: './mcpe-common/tests/acceptance/scanngo-acceptance.postman_collection.json'
      acceptance-postman-environment-path:
        description: 'Path to Postman environment variables'
        required: false
        type: string
        default: './mcpe-common/tests/acceptance/scanngo-acceptance.postman_environment.json'
      acceptance-globals-path:
        description: 'Path to globals.json'
        required: false
        type: string
        default: './mcpe-common/tests/acceptance/globals.json'
      start-sql:
        type: boolean
        required: false
      start-redis:
        type: boolean
        required: false
      liquibase-path:
        description: "Path to Liquibase changelog file (relative to repo root). If set, Liquibase migrations will run before deployment."
        type: string
        required: false
      liquibase-search-path:
        description: "Additional path to search for SQL changesets (e.g., 'liquibase/sql')"
        type: string
        required: false
      liquibase-db-instance-secret:
        description: "GCP Secret Manager secret name containing the Cloud SQL instance connection string"
        type: string
        required: false
      liquibase-db-name:
        description: "Target database name for Liquibase migrations"
        type: string
        required: false
      liquibase-db-user:
        description: "Database username for Liquibase connection"
        type: string
        required: false
      liquibase-db-pass-secret:
        description: "GCP Secret Manager secret name containing the database password"
        type: string
        required: false
      release-name:
        type: string
        required: false
        default: "Release"
      product-name:
        type: string
        required: false
        default: "Scan & Go"
      product-component:
        type: string
        required: false
        default: "scanngo"
      config-nuget:
        type: boolean
        required: false
        default: true
      slack-channel:
        description: Name of the channel to notify failing action
        required: false
        default: selfscan-pipeline-notifications
        type: string
      code-freeze:
        description: |
            Code freeze flag. Use this flag when there is a code freeze and code changes should not be deployed to staging and production environments.
        type: boolean
        required: false
      release-to-staging-only:
        description: 'A flag to stop deploy to Production after running acceptance tests in Staging'
        type: boolean
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start Redis
        if: ${{ inputs.start-redis }}
        shell: bash
        run: docker container run --name redis --rm -d -p 6379:6379 redis:6

      - name: Start SQL
        if: ${{ inputs.start-sql }}
        shell: bash
        run: |
          docker run --rm -d -p 5433:1433 -e ACCEPT_EULA=Y -e MSSQL_SA_PASSWORD="${{ secrets.sql-password }}" --name sql-server mcr.microsoft.com/mssql/server:2017-latest

      - name: Build and test
        uses: extenda/shared-workflows/composite-actions/dotnet-build-and-test@feat/MCPE-5201
        with:
          sln-path: ${{ inputs.sln-path }}
          secret-auth: ${{ secrets.secret-auth }}
          gcloud-auth-staging: ${{ secrets.gcloud-auth-staging }}

      - name: Stop Redis
        if: ${{ inputs.start-redis }}
        shell: bash
        run: docker container stop redis

      - name: Stop SQL server
        if: ${{ inputs.start-sql }}
        shell: bash
        run: docker stop sql-server

      - name: Notify Slack if build fails
        uses: extenda/actions/slack-notify@v0
        if: failure() && github.ref == 'refs/heads/master'
        with:
          text: |
            *Build failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Build failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}


  docker-build:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name:  Code freeze check
        run: |
          commit_message=$(cat <<EOF
          ${{ github.event.head_commit.message }}
          EOF
          )
          if [[ "${{ inputs.code-freeze }}" == "true" && $commit_message != *"[force-deploy]"* ]]; then
            echo "Code freeze flag is enabled. Skipping deployment.";
            echo "To trigger a deployment that bypasses the code-freeze input checks, include '[force-deploy]' in the commit message.";
            exit 1
          else
            echo "Code freeze is not enabled. Proceeding with deployment."
          fi

      - name: NuGet config
        if: ${{ inputs.config-nuget }}
        uses: extenda/shared-workflows/composite-actions/dotnet-nuget-config@master
        with:
          secret-auth: ${{ secrets.secret-auth }}

      - name: Build Docker image
        uses: extenda/shared-workflows/composite-actions/docker-build@master
        with:
          gcloud-auth-staging: ${{ secrets.gcloud-auth-staging }}
          dockerfile-path: ${{ inputs.dockerfile-path }}
          gcr-image-name: ${{ inputs.gcr-image-name }}

      - name: Notify Slack if docker-build fails
        uses: extenda/actions/slack-notify@v0
        if: |
            failure() &&
            (!inputs.code-freeze || contains(github.event.head_commit.message, '[force-deploy]'))
        with:
          text: |
            *Docker build failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Docker build failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}

  liquibase-staging:
    if: ${{ inputs.liquibase-path }}
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GCloud
        uses: extenda/actions/setup-gcloud@v0
        with:
          service-account-key: ${{ secrets.gcloud-auth-staging }}
          export-default-credentials: true

      - name: Fetch database secrets
        uses: extenda/actions/gcp-secret-manager@v0
        with:
          service-account-key: ${{ secrets.gcloud-auth-staging }}
          secrets: |
            DB_INST: ${{ inputs.liquibase-db-instance-secret }}
            DB_PASS: ${{ inputs.liquibase-db-pass-secret }}

      - name: Setup Cloud SQL Proxy
        shell: bash
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.2/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          nohup ./cloud-sql-proxy ${{ env.DB_INST }} --address 127.0.0.1 --port 5432 > cloud-sql-proxy.log 2>&1 &
          echo "CLOUD_SQL_PROXY_PID=$!" >> $GITHUB_ENV
          sleep 5

      - name: Create database if not exists
        shell: bash
        run: |
          PGPASSWORD="${{ env.DB_PASS }}" psql -h 127.0.0.1 -U ${{ inputs.liquibase-db-user }} -d postgres -tc \
            "SELECT 1 FROM pg_database WHERE datname = '${{ inputs.liquibase-db-name }}'" | grep -q 1 || \
          PGPASSWORD="${{ env.DB_PASS }}" psql -h 127.0.0.1 -U ${{ inputs.liquibase-db-user }} -d postgres -c \
            "CREATE DATABASE \"${{ inputs.liquibase-db-name }}\""

      - name: Setup Liquibase
        uses: liquibase/setup-liquibase@v2
        with:
          version: '4.32.0'
          edition: community

      - name: Run Liquibase migrations
        shell: bash
        run: |
          liquibase \
            --search-path="${{ inputs.liquibase-search-path }}" \
            update \
            --changelog-file="${{ inputs.liquibase-path }}" \
            --url="jdbc:postgresql://127.0.0.1:5432/${{ inputs.liquibase-db-name }}" \
            --username="${{ inputs.liquibase-db-user }}" \
            --password="${{ env.DB_PASS }}"

      - name: Stop Cloud SQL Proxy
        if: always()
        shell: bash
        run: |
          if [ -n "${{ env.CLOUD_SQL_PROXY_PID }}" ]; then
            kill ${{ env.CLOUD_SQL_PROXY_PID }} || true
          fi

      - name: Notify Slack if Liquibase staging fails
        uses: extenda/actions/slack-notify@v0
        if: failure()
        with:
          text: |
            *Liquibase staging migrations failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Liquibase failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}

  staging:
    if: |
      always() &&
      (needs.docker-build.result == 'success') &&
      (needs.liquibase-staging.result == 'success' || needs.liquibase-staging.result == 'skipped')
    runs-on: ubuntu-22.04
    needs: [docker-build, liquibase-staging]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to staging
        uses: extenda/shared-workflows/composite-actions/deploy-to-staging@master
        with:
          secret-auth: ${{ secrets.secret-auth }}
          gcloud-auth-staging: ${{ secrets.gcloud-auth-staging }}
          gcr-image-name: ${{ inputs.gcr-image-name }}

      - name: Notify Slack if staging fails
        uses: extenda/actions/slack-notify@v0
        if: failure()
        with:
          text: |
            *Staging failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Staging failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}

  acceptance:
    if: ${{ inputs.use-scanngo-acceptance }}
    runs-on: ubuntu-22.04
    needs: staging
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Acceptance
        if: ${{ inputs.system-name == 'sng' }}
        uses: extenda/shared-workflows/composite-actions/sng/acceptance@master
        with:
          secret-auth: ${{ secrets.secret-auth }}
          gcloud-auth-staging: ${{ secrets.gcloud-auth-staging }}
          acceptance-username: ${{ inputs.acceptance-username }}
          acceptance-postman-collection-path: ${{ inputs.acceptance-postman-collection-path }}
          acceptance-postman-environment-path: ${{ inputs.acceptance-postman-environment-path }}
          acceptance-globals-path: ${{ inputs.acceptance-globals-path }}

      - name: Acceptance
        if: ${{ inputs.system-name == 'mys' }}
        uses: extenda/shared-workflows/composite-actions/mys/acceptance@master
        with:
          secret-auth: ${{ secrets.secret-auth }}
          gcloud-auth-staging: ${{ secrets.gcloud-auth-staging }}
          acceptance-username: ${{ inputs.acceptance-username }}
          acceptance-postman-collection-path: ${{ inputs.acceptance-postman-collection-path }}
          acceptance-postman-environment-path: ${{ inputs.acceptance-postman-environment-path }}
          acceptance-globals-path: ${{ inputs.acceptance-globals-path }}

      - name: Notify Slack if acceptance fails
        uses: extenda/actions/slack-notify@v0
        if: failure()
        with:
          text: |
            *Acceptance failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Acceptance failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}

  liquibase-prod:
    if: |
      inputs.liquibase-path &&
      always() &&
      (!inputs.release-to-staging-only) &&
      (needs.acceptance.result == 'success' || needs.acceptance.result == 'skipped') &&
      (needs.staging.result == 'success')
    runs-on: ubuntu-22.04
    needs: [acceptance, staging]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GCloud
        uses: extenda/actions/setup-gcloud@v0
        with:
          service-account-key: ${{ secrets.gcloud-auth-prod }}
          export-default-credentials: true

      - name: Fetch database secrets
        uses: extenda/actions/gcp-secret-manager@v0
        with:
          service-account-key: ${{ secrets.gcloud-auth-prod }}
          secrets: |
            DB_INST: ${{ inputs.liquibase-db-instance-secret }}
            DB_PASS: ${{ inputs.liquibase-db-pass-secret }}

      - name: Setup Cloud SQL Proxy
        shell: bash
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.2/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          nohup ./cloud-sql-proxy ${{ env.DB_INST }} --address 127.0.0.1 --port 5432 > cloud-sql-proxy.log 2>&1 &
          echo "CLOUD_SQL_PROXY_PID=$!" >> $GITHUB_ENV
          sleep 5

      - name: Create database if not exists
        shell: bash
        run: |
          PGPASSWORD="${{ env.DB_PASS }}" psql -h 127.0.0.1 -U ${{ inputs.liquibase-db-user }} -d postgres -tc \
            "SELECT 1 FROM pg_database WHERE datname = '${{ inputs.liquibase-db-name }}'" | grep -q 1 || \
          PGPASSWORD="${{ env.DB_PASS }}" psql -h 127.0.0.1 -U ${{ inputs.liquibase-db-user }} -d postgres -c \
            "CREATE DATABASE \"${{ inputs.liquibase-db-name }}\""

      - name: Setup Liquibase
        uses: liquibase/setup-liquibase@v2
        with:
          version: '4.32.0'
          edition: community

      - name: Run Liquibase migrations
        shell: bash
        run: |
          liquibase \
            --search-path="${{ inputs.liquibase-search-path }}" \
            update \
            --changelog-file="${{ inputs.liquibase-path }}" \
            --url="jdbc:postgresql://127.0.0.1:5432/${{ inputs.liquibase-db-name }}" \
            --username="${{ inputs.liquibase-db-user }}" \
            --password="${{ env.DB_PASS }}"

      - name: Stop Cloud SQL Proxy
        if: always()
        shell: bash
        run: |
          if [ -n "${{ env.CLOUD_SQL_PROXY_PID }}" ]; then
            kill ${{ env.CLOUD_SQL_PROXY_PID }} || true
          fi

      - name: Notify Slack if Liquibase production fails
        uses: extenda/actions/slack-notify@v0
        if: failure()
        with:
          text: |
            *Liquibase production migrations failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Liquibase failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}

  production:
    if: |
      always() &&
      (!inputs.release-to-staging-only) &&
      (needs.acceptance.result == 'success' || needs.acceptance.result == 'skipped') &&
      (needs.staging.result == 'success') &&
      (needs.liquibase-prod.result == 'success' || needs.liquibase-prod.result == 'skipped')
    runs-on: ubuntu-22.04
    needs: [acceptance, staging, liquibase-prod]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to production
        uses: extenda/shared-workflows/composite-actions/deploy-to-production@master
        with:
          secret-auth: ${{ secrets.secret-auth }}
          gcloud-auth-prod: ${{ secrets.gcloud-auth-prod }}
          gcr-image-name: ${{ inputs.gcr-image-name }}
          service-name: ${{ inputs.service-name }}
          system-name: ${{ inputs.system-name }}
          release-name: ${{ inputs.release-name }}
          product-name: ${{ inputs.product-name }}
          product-component: ${{ inputs.product-component }}

      - name: Notify Slack if production fails
        uses: extenda/actions/slack-notify@v0
        if: failure()
        with:
          text: |
            *Production failed for ${{ github.repository }}: ${{ github.workflow }}* :heavy_exclamation_mark:
            Production failed on ${{ github.event_name }} event. Workflow: ${{ github.workflow }}. Job: ${{github.job}}. Run id: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
          channel: ${{ inputs.slack-channel }}
          service-account-key: ${{ secrets.secret-auth }}
