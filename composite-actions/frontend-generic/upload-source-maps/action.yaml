name: Source map upload
description: "A GitHub Action to manage source maps by uploading and deleting them in Elasticsearch."

on:
  workflow_run:
    workflows: ["Commit"]
    types:
      - completed

inputs:
  SERVICE_NAME:
    description: "Service name for the source maps"
    required: true
  SERVICE_VERSION:
    description: "Service version"
    required: true
  BUILD_DIR:
    description: "Build directory containing source maps"
    required: true
  SECRET_AUTH:
    description: "GCP Auth"
    required: true
  GCLOUD_AUTH_STAGING:
    description: "GCP Auth (staging)"
    required: true

runs:
  using: composite
  steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Auth to Nexus npm registry
      uses: extenda/actions/nexus-auth-npm@v0
      with:
        service-account-key: ${{ inputs.SECRET_AUTH }}

    - name: Install dependencies
      shell: bash
      run: yarn install --frozen-lockfile

    - name: Build
      shell: bash
      run: yarn run build

    - name: Setting secrets
      uses: extenda/actions/gcp-secret-manager@v0
      with:
        service-account-key: ${{ inputs.GCLOUD_AUTH_STAGING }}
        secrets: |
          ELASTICSEARCH_API_KEY: frontend-elasticsearch-api-key
          ELASTICSEARCH_URL: frontend-elasticsearch-sourcemaps-url

    - name: Upload source maps
      shell: bash
      run: node ./scripts/upload-source-maps.js
      env:
        SERVICE_NAME: ${{ inputs.SERVICE_NAME }}
        SERVICE_VERSION: ${{ inputs.SERVICE_VERSION }}
        BUILD_DIR: ${{ inputs.BUILD_DIR }}
