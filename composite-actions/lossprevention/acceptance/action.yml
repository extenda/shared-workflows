name: 'Acceptance'
description: 'Acceptance action for lossprevention services'

inputs:
  secret-auth:
    description: 'SECRET_AUTH value from secrets'
    required: true
  gcloud-auth:
    description: 'GCLOUD_AUTH_STAGING/GCLOUD_AUTH_PROD value from secrets based on the environment'
    required: true
  collections_folder:
    description: 'Folder to use collections'
    required: false
    default: './slp/tests/acceptance/'
  environment:
    description: 'Environment to use'
    required: false
    default: './slp/tests/acceptance/integration_test.staging.postman_environment.json'

runs:
  using: 'composite'
  steps:
    - uses: extenda/actions/gcp-secret-manager@v0
      with:
        service-account-key: ${{ inputs.secret-auth }}
        secrets: |
          GITHUB-TOKEN: github-token

    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: extenda/selfservice-lossprevention-common
        path: 'slp'
        token: ${{ env.GITHUB-TOKEN }}

    - name: Set up GCloud
      uses: extenda/actions/setup-gcloud@v0
      id: gcloud
      with:
        service-account-key: ${{ inputs.gcloud-auth }}

    - name: Identity token
      uses: extenda/actions/identity-token@v0
      with:
        service-account-key: ${{ inputs.gcloud-auth }}
        service-account: basketauditfrontend@${{ steps.gcloud.outputs.project-id }}.iam.gserviceaccount.com
        audiences: basketauditfrontend

    - name: List collection files
      id: list_collections
      run: |
        collections=$(find "${{ inputs.collections_folder }}" -name '*.postman_collection.json' -type f)
        echo "Found collections:"
        echo "$collections"
        echo "::set-output name=collections::$(echo "$collections" | tr '\n' ',')"

    - name: Acceptance tests
      shell: bash
      run: |
          npm install newman --no-save --silent
          IFS=',' read -ra COLLECTIONS_ARRAY <<< "${{ steps.list_collections.outputs.collections }}"
          for collection in "${COLLECTIONS_ARRAY[@]}"; do
            echo "Running tests for collection: $collection"
            npx newman run "$collection" \
              --environment tests/integration_test.staging.postman_environment.json \
              --env-var iamToken=$IDENTITY_TOKEN
          done
