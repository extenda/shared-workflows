name: 'Publish Library'
description: 'Publishes library to Artifact Registry'
inputs:
    SECRET_AUTH:
        description: 'GCP Service Account Key with access to Secret Manager and SonarCloud'
        required: true
    GCLOUD_AUTH_PROD:
        description: 'GCP Service Account Key with access to Artifact Registry'
        required: true
    GITHUB_TOKEN:
        description: 'GitHub Token to create releases'
        required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Cache node_modules
      uses: actions/cache@v4
      id: cache-node-modules
      env:
        cache-name: cache-node-modules
      with:
        path: node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-modules

    - name: Cache Sonar binary
      uses: actions/cache@v4
      env:
        cache-name: cache-sonar-binary
      with:
        path: /home/runner/.sonar/native-sonar-scanner
        key: ${{ runner.os }}-cache-sonar-binary
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version-file: .nvmrc

    - uses: extenda/actions/setup-gcloud@v0
      with:
        service-account-key: ${{ inputs.SECRET_AUTH }}
        export-default-credentials: 'true'

    - name: Install dependencies
      run: npm ci --ignore-scripts

    - name: Lint
      run: npm run lint:ci

    - name: Build
      run: npm run build

    - name: Test
      run: npm test

    - name: Analyze with SonarCloud
      uses: extenda/actions/sonar-scanner@v0
      with:
        sonar-host: https://sonarcloud.io
        service-account-key: ${{ inputs.SECRET_AUTH }}
        sonar-scanner: node

    - uses: extenda/actions/setup-gcloud@v0
      with:
        service-account-key: ${{ inputs.GCLOUD_AUTH_PROD }}
        export-default-credentials: 'true'

    - name: Write .npmrc
      run: echo "@hiiretail:registry = https://europe-west1-npm.pkg.dev/extenda/npm-releases" > .npmrc

    - name: Release
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      run: npm run auth && NPM_TOKEN=$(gcloud auth print-access-token) npx semantic-release